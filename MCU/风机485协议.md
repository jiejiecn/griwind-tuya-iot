# 风机485通信协议文档

## 1. 通信参数

| 参数 | 值 | 说明 |
|------|-----|------|
| 通信方式 | RS485 | 半双工串行通信 |
| 波特率 | 9600 bps | 固定波特率 |
| 数据位 | 8 | 标准数据位 |
| 停止位 | 1 | 标准停止位 |
| 校验位 | 无 | 无校验位 |
| 协议类型 | Modbus RTU | 标准Modbus RTU协议 |
| 从站地址 | 0xA1 (161) | 风机设备地址 |
| 超时时间 | 200ms | 读取响应超时时间 |

## 2. 寄存器定义

### 2.1 寄存器地址表

| 寄存器地址 | 名称 | 数据类型 | 范围 | 说明 |
|-----------|------|---------|------|------|
| 0x1005 | 开关寄存器 | uint16 | 0=关闭, 1=开启 | 控制风机开关状态 |
| 0x1006 | 保留寄存器 | uint16 | - | 保留，暂未使用 |
| 0x1007 | 档位寄存器 | uint16 | 1~4 | 控制风机速度档位 |

### 2.2 寄存器详细说明

#### 开关寄存器 (0x1005)
- **功能**: 控制风机开关状态
- **读写**: 可读写
- **数据格式**: 16位无符号整数（大端序）
- **取值范围**:
  - `0x0000` (0): 关闭风机
  - `0x0001` (1): 开启风机
- **行为**: 写入0关闭风机，写入1开启风机

#### 档位寄存器 (0x1007)
- **功能**: 控制风机速度档位
- **读写**: 可读写
- **数据格式**: 16位无符号整数（大端序）
- **取值范围**: `0x0001` (1) ~ `0x0004` (4)
- **行为**: 写入1~4设置对应档位速度

## 3. Modbus功能码

| 功能码 | 名称 | 说明 | 使用场景 |
|--------|------|------|---------|
| 0x03 | 读保持寄存器 | 读取一个或多个保持寄存器 | 查询风机状态 |
| 0x06 | 写单个寄存器 | 写入单个保持寄存器 | 控制风机开关/速度 |
| 0x83 | 异常响应 | 读寄存器异常响应 | 错误处理 |
| 0x86 | 异常响应 | 写寄存器异常响应 | 错误处理 |

## 4. 帧格式

### 4.1 读寄存器请求帧格式

| 字节位置 | 字段名 | 长度 | 说明 | 示例值 |
|---------|--------|------|------|--------|
| 0 | 从站地址 | 1字节 | 设备地址 | 0xA1 |
| 1 | 功能码 | 1字节 | 0x03 | 0x03 |
| 2-3 | 起始地址 | 2字节 | 寄存器起始地址（大端） | 0x10 0x05 |
| 4-5 | 寄存器数量 | 2字节 | 读取寄存器数量（大端） | 0x00 0x03 |
| 6-7 | CRC校验 | 2字节 | CRC16校验（小端） | 0x09 0xAA |

**示例**: 查询状态 `A1 03 10 05 00 03 09 AA`

### 4.2 读寄存器响应帧格式

| 字节位置 | 字段名 | 长度 | 说明 | 示例值 |
|---------|--------|------|------|--------|
| 0 | 从站地址 | 1字节 | 设备地址 | 0xA1 |
| 1 | 功能码 | 1字节 | 0x03 | 0x03 |
| 2 | 字节数 | 1字节 | 数据字节数（寄存器数×2） | 0x06 |
| 3-8 | 数据 | N字节 | 寄存器数据（大端，每寄存器2字节） | 见下表 |
| 最后2字节 | CRC校验 | 2字节 | CRC16校验（小端） | - |

**数据解析示例**（查询3个寄存器）:
- 字节3-4: 开关状态 (0x0000=关闭, 0x0001=开启)
- 字节5-6: 保留寄存器
- 字节7-8: 速度档位 (0x0001~0x0004)

### 4.3 写单个寄存器请求帧格式

| 字节位置 | 字段名 | 长度 | 说明 | 示例值 |
|---------|--------|------|------|--------|
| 0 | 从站地址 | 1字节 | 设备地址 | 0xA1 |
| 1 | 功能码 | 1字节 | 0x06 | 0x06 |
| 2-3 | 寄存器地址 | 2字节 | 目标寄存器地址（大端） | 0x10 0x05 |
| 4-5 | 寄存器值 | 2字节 | 写入的值（大端） | 0x00 0x01 |
| 6-7 | CRC校验 | 2字节 | CRC16校验（小端） | 0x44 0x6B |

**示例**: 
- 打开风机 `A1 06 10 05 00 01 44 6B`
- 关闭风机 `A1 06 10 05 00 00 85 AB`
- 1档 `A1 06 10 07 00 01 E5 AB`
- 2档 `A1 06 10 07 00 02 A5 AA`
- 3档 `A1 06 10 07 00 03 64 6A`
- 4档 `A1 06 10 07 00 04 25 A8`

### 4.4 写单个寄存器响应帧格式

| 字节位置 | 字段名 | 长度 | 说明 |
|---------|--------|------|------|
| 0 | 从站地址 | 1字节 | 设备地址 |
| 1 | 功能码 | 1字节 | 0x06 |
| 2-3 | 寄存器地址 | 2字节 | 回显寄存器地址（大端） |
| 4-5 | 寄存器值 | 2字节 | 回显写入的值（大端） |
| 6-7 | CRC校验 | 2字节 | CRC16校验（小端） |

**说明**: 写操作成功后，从站会回显请求帧的寄存器地址和值，用于确认写入成功。

### 4.5 异常响应帧格式

| 字节位置 | 字段名 | 长度 | 说明 |
|---------|--------|------|------|
| 0 | 从站地址 | 1字节 | 设备地址 |
| 1 | 异常功能码 | 1字节 | 原功能码 | 0x80 |
| 2 | 异常码 | 1字节 | 错误代码 |
| 3-4 | CRC校验 | 2字节 | CRC16校验（小端） |

**常见异常码**:
- 0x01: 非法功能码
- 0x02: 非法数据地址
- 0x03: 非法数据值
- 0x04: 从站设备故障

## 5. CRC16校验算法

### 5.1 算法说明

采用标准Modbus RTU CRC16校验算法：
- 多项式: 0xA001 (反向)
- 初始值: 0xFFFF
- 结果字节序: 小端序（低字节在前）

### 5.2 算法实现（Python示例）

```python
def modbus_crc16(data):
    """
    Modbus RTU CRC16校验算法
    :param data: 字节数组或字节串
    :return: 16位CRC校验值
    """
    crc = 0xFFFF
    for b in data:
        crc ^= b
        for _ in range(8):
            if crc & 0x0001:
                crc = (crc >> 1) ^ 0xA001
            else:
                crc >>= 1
    return crc & 0xFFFF

# 使用示例
frame = bytearray([0xA1, 0x03, 0x10, 0x05, 0x00, 0x03])
crc = modbus_crc16(frame)
frame.append(crc & 0xFF)        # 低字节
frame.append((crc >> 8) & 0xFF) # 高字节
```

### 5.3 CRC计算步骤

1. 初始化CRC寄存器为0xFFFF
2. 对每个数据字节：
   - CRC寄存器与数据字节异或
   - 循环8次：
     - 如果最低位为1，右移1位并与0xA001异或
     - 否则仅右移1位
3. 将CRC值以小端序附加到帧末尾（低字节在前）

## 6. 命令示例

### 6.1 查询风机状态

**请求**:
```
A1 03 10 05 00 03 09 AA
```

**解析**:
- `A1`: 从站地址
- `03`: 读保持寄存器功能码
- `10 05`: 起始地址0x1005
- `00 03`: 读取3个寄存器
- `09 AA`: CRC校验

**响应示例**:
```
A1 03 06 00 01 00 00 00 03 XX XX
```

**解析**:
- `A1`: 从站地址
- `03`: 功能码
- `06`: 数据字节数（3个寄存器×2字节）
- `00 01`: 开关状态（1=开启）
- `00 00`: 保留寄存器
- `00 03`: 速度档位（3档）
- `XX XX`: CRC校验

### 6.2 打开风机

**请求**:
```
A1 06 10 05 00 01 44 6B
```

**解析**:
- `A1`: 从站地址
- `06`: 写单个寄存器功能码
- `10 05`: 寄存器地址0x1005（开关寄存器）
- `00 01`: 写入值1（开启）
- `44 6B`: CRC校验

**响应**:
```
A1 06 10 05 00 01 44 6B
```
（回显请求帧，用于确认）

### 6.3 关闭风机

**请求**:
```
A1 06 10 05 00 00 85 AB
```

**响应**:
```
A1 06 10 05 00 00 85 AB
```

### 6.4 设置速度档位

#### 1档
**请求**: `A1 06 10 07 00 01 E5 AB`

#### 2档
**请求**: `A1 06 10 07 00 02 A5 AA`

#### 3档
**请求**: `A1 06 10 07 00 03 64 6A`

#### 4档
**请求**: `A1 06 10 07 00 04 25 A8`

**说明**: 所有写操作成功后都会回显相同的请求帧。

## 7. 通信流程

### 7.1 状态查询流程

```
主站                   从站（风机）
  |                      |
  |--- 读寄存器请求 ----->|
  |   (0x1005, 3个)      |
  |                      |
  |<-- 读寄存器响应 ------|
  |   (开关+保留+速度)   |
  |                      |
```

### 7.2 控制命令流程

```
主站                   从站（风机）
  |                      |
  |--- 写寄存器请求 ----->|
  |   (地址+值)          |
  |                      |
  |<-- 写寄存器响应 ------|
  |   (回显确认)         |
  |                      |
```

## 8. 错误处理

### 8.1 超时处理

- **超时时间**: 200ms
- **处理方式**: 如果在超时时间内未收到响应，视为通信失败
- **建议**: 实现重试机制，最多重试3次

### 8.2 CRC校验失败

- **检测**: 响应帧CRC校验值与计算值不匹配
- **处理**: 丢弃该帧，记录错误，可重试

### 8.3 长度错误

- **检测**: 响应帧长度不符合预期
- **处理**: 丢弃该帧，记录错误，可重试

### 8.4 地址/功能码错误

- **检测**: 响应帧地址或功能码与请求不匹配
- **处理**: 丢弃该帧，检查总线连接

### 8.5 异常响应

- **检测**: 功能码高位置1（如0x83表示读寄存器异常）
- **处理**: 解析异常码，根据错误类型处理

## 9. 数据字节序

- **寄存器地址**: 大端序（高字节在前）
- **寄存器值**: 大端序（高字节在前）
- **CRC校验**: 小端序（低字节在前）

## 10. 注意事项

1. **RS485方向控制**: 发送数据前切换到发送模式，发送完成后切换到接收模式
2. **帧间隔**: 帧与帧之间应有至少3.5个字符时间的间隔
3. **重试机制**: 建议实现自动重试，提高通信可靠性
4. **状态同步**: 建议定期查询状态，确保主站与从站状态一致
5. **错误统计**: 建议记录通信错误统计，便于故障诊断

## 11. 寄存器映射表（快速参考）

| 操作 | 寄存器地址 | 写入值 | 请求帧示例 |
|------|-----------|--------|-----------|
| 打开风机 | 0x1005 | 0x0001 | `A1 06 10 05 00 01 44 6B` |
| 关闭风机 | 0x1005 | 0x0000 | `A1 06 10 05 00 00 85 AB` |
| 1档 | 0x1007 | 0x0001 | `A1 06 10 07 00 01 E5 AB` |
| 2档 | 0x1007 | 0x0002 | `A1 06 10 07 00 02 A5 AA` |
| 3档 | 0x1007 | 0x0003 | `A1 06 10 07 00 03 64 6A` |
| 4档 | 0x1007 | 0x0004 | `A1 06 10 07 00 04 25 A8` |
| 查询状态 | 0x1005 | 读3个 | `A1 03 10 05 00 03 09 AA` |

## 12. 版本历史

| 版本 | 日期 | 说明 |
|------|------|------|
| 1.0 | 2025-01 | 初始版本 |

---

**文档维护**: 如有协议变更，请及时更新本文档。

